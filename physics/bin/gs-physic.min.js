window.gs.physics={};var gs,__read=this&&this.__read||function(t,i){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,r,s=e.call(t),o=[];try{for(;(void 0===i||i-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(t){r={error:t}}finally{try{n&&!n.done&&(e=s.return)&&e.call(s)}finally{if(r)throw r.error}}return o},__spread=this&&this.__spread||function(){for(var t=[],i=0;i<arguments.length;i++)t=t.concat(__read(arguments[i]));return t},__values=this&&this.__values||function(t){var i="function"==typeof Symbol&&t[Symbol.iterator],e=0;return i?i.call(t):{next:function(){return t&&e>=t.length&&(t=void 0),{value:t&&t[e++],done:!t}}}};window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])};return function(i,e){function n(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),function(t){!function(t){var i=function(){function i(t,i,e,n){this.velocityX=0,this.velocityY=0,this.minX=t,this.maxX=t+e,this.minY=i,this.maxY=i+n}return i.prototype.union=function(t){var e=Math.min(this.minX,t.minX),n=Math.min(this.minY,t.minY);return new i(e,n,Math.max(this.maxX,t.maxX)-e,Math.max(this.maxY,t.maxY)-n)},i.prototype.area=function(){return(this.maxX-this.minX)*(this.maxY-this.minY)},i.prototype.intersects=function(t){return!(this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY)},i.prototype.getCenter=function(){var i=(this.minX+this.maxX)/2,e=(this.minY+this.maxY)/2;return new t.Point(i,e)},i.prototype.computeCollisionTime=function(t){var i,e,n,r,s=t.velocityX-this.velocityX,o=t.velocityY-this.velocityY;s>0?(i=(this.minX-t.maxX)/s,n=(this.maxX-t.minX)/s):(i=(this.maxX-t.minX)/s,n=(this.minX-t.maxX)/s),o>0?(e=(this.minY-t.maxY)/o,r=(this.maxY-t.minY)/o):(e=(this.maxY-t.minY)/o,r=(this.minY-t.maxY)/o);var a=Math.max(i,e),h=Math.min(n,r);return a<h&&a<1&&h>0?a:1/0},i.prototype.clone=function(){var t=this.maxX-this.minX,e=this.maxY-this.minY,n=new i(this.minX,this.minY,t,e);return n.velocityX=this.velocityX,n.velocityY=this.velocityY,n},i}();t.AABB=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function i(i){this.left=null,this.right=null,this.object=i||null,this.bounds=i?i.clone():new t.AABB(0,0,-1/0,-1/0)}return i.prototype.insert=function(t){if(!this.left&&!this.right)return this.object=t,this.bounds=t,this.createChildNodes(),!1;var i=this.left.bounds.union(t),e=this.right.bounds.union(t);if(i.area()*(this.left.size()+1)-this.bounds.area()*this.size()<e.area()*(this.right.size()+1)-this.bounds.area()*this.size()){var n=this.left.insert(t);return this.bounds=this.bounds.union(t),n}n=this.right.insert(t);return this.bounds=this.bounds.union(t),n},i.prototype.createChildNodes=function(){var e=this.bounds.getCenter(),n=new t.AABB(this.bounds.minX,this.bounds.minY,e.x-this.bounds.minX,this.bounds.maxY-this.bounds.minY),r=new t.AABB(e.x,this.bounds.minY,this.bounds.maxX-e.x,this.bounds.maxY-this.bounds.minY);this.left=new i(n),this.right=new i(r)},i.prototype.remove=function(t){if(this.object===t)return this.object=null,!0;if(this.left&&this.right){var i=this.left.remove(t)||this.right.remove(t);return i&&this.updateBounds(),i}return!1},i.prototype.updateBounds=function(){this.bounds=this.left.bounds.union(this.right.bounds)},i.prototype.query=function(t){if(!this.bounds.intersects(t))return[];var i=[];return this.object?this.object.intersects(t)&&i.push(this.object):(this.left&&i.push.apply(i,__spread(this.left.query(t))),this.right&&i.push.apply(i,__spread(this.right.query(t)))),i},i.prototype.size=function(){return this.left||this.right?this.left.size()+this.right.size():1},i.prototype.getObjects=function(){if(this.object)return[this.object];var t=[];return this.left&&t.push.apply(t,__spread(this.left.getObjects())),this.right&&t.push.apply(t,__spread(this.right.getObjects())),t},i}();t.BVHNode=i;var e=function(){function t(){this.root=new i}return t.prototype.insert=function(t){var e,n;if(this.root.insert(t)){var r=this.root.getObjects();this.root=new i;try{for(var s=__values(r),o=s.next();!o.done;o=s.next()){var a=o.value;this.root.insert(a)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}}},t.prototype.query=function(t){return this.root.query(t)},t.prototype.filterPairs=function(t){var i,e,n=[];try{for(var r=__values(t),s=r.next();!s.done;s=r.next()){var o=s.value,a=o[0],h=o[1];-1!=this.query(a).indexOf(h)&&n.push(o)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(e=r.return)&&e.call(r)}finally{if(i)throw i.error}}return n},t.prototype.remove=function(t){var e,n;if(this.root.remove(t)){var r=this.root.getObjects();this.root=new i;try{for(var s=__values(r),o=s.next();!o.done;o=s.next()){var a=o.value;this.root.insert(a)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}}},t.prototype.update=function(t,i){this.remove(t),t.minX=i.minX,t.minY=i.minY,t.maxX=i.maxX,t.maxY=i.maxY,this.insert(t)},t}();t.BVH=e}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(i){var e=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.onInitialize=function(t){this.aabb=t},i}(t.Component);i.PhysicsComponent=e}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function i(i,e,n){void 0===i&&(i=new t.Rectangle(0,0,1e3,1e3)),void 0===e&&(e=4),void 0===n&&(n=10),this.quadtree=new t.QuadTree(i,e,n),this.bvh=new t.BVH,this.entities=new Map}return i.prototype.addObject=function(t,i){this.entities.set(t,i),this.quadtree.insert(i),this.bvh.insert(i)},i.prototype.removeObject=function(t){var i=this.entities.get(t);i&&(this.bvh.remove(i),this.quadtree.remove(i),this.entities.delete(t))},i.prototype.updateObject=function(t,i){var e=this.entities.get(t);e&&(this.bvh.remove(e),this.quadtree.remove(e),e.minX=i.minX,e.minY=i.minY,e.maxX=i.maxX,e.maxY=i.maxY,this.bvh.insert(e),this.quadtree.insert(e))},i.prototype.step=function(i){var e,n,r=this.quadtree.queryPairs();r=t.SweepAndPrune.sweepAndPrune(r),r=this.bvh.filterPairs(r);try{for(var s=__values(r),o=s.next();!o.done;o=s.next()){var a=o.value,h=__read(a,2),u=h[0],c=h[1],l=__read(t.TimeBaseCollisionDetection.handleCollision(u,c),2),y=l[0],f=l[1];this.quadtree.update(u,y),this.bvh.update(u,y),this.quadtree.update(c,f),this.bvh.update(c,f)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}},i}();t.PhysicsEngine=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){var i,e;i=t.physics||(t.physics={}),e=function(e){function n(n,r,s,o){void 0===r&&(r=new i.Rectangle(0,0,1e3,1e3)),void 0===s&&(s=4),void 0===o&&(o=10);var a=e.call(this,n,0,t.Matcher.empty().all(i.PhysicsComponent))||this;return a.engine=new i.PhysicsEngine(r,s,o),a}return __extends(n,e),n.prototype.onComponentAdded=function(t,e){e instanceof i.PhysicsComponent&&this.engine.addObject(t.getId(),e.aabb)},n.prototype.onComponentRemoved=function(t,i){this.engine.removeObject(t.getId())},n.prototype.update=function(e){var n,r;try{for(var s=__values(e),o=s.next();!o.done;o=s.next())o.value.getComponent(i.PhysicsComponent)}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}var a=t.TimeManager.getInstance().deltaTime;this.engine.step(a)},n}(t.System),i.PhysicsSystem=e}(gs||(gs={})),function(t){!function(t){var i=function(){return function(t,i){this.x=t,this.y=i}}();t.Point=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function i(i,e,n){this.boundary=i,this.capacity=e,this.cellSize=n,this.nw=null,this.ne=null,this.sw=null,this.se=null,this.aabbs=[],this.spatialHash=new t.SpatialHash(n)}return i.prototype.insert=function(t){return!!this.boundary.containsAABB(t)&&(this.aabbs.length<this.capacity&&null===this.nw?(this.aabbs.push(t),this.spatialHash.insert(t),!0):(null===this.nw&&this.subdivide(),!!this.nw.insert(t)||(!!this.ne.insert(t)||(!!this.sw.insert(t)||(!!this.se.insert(t)||(this.aabbs.push(t),this.spatialHash.insert(t),!0))))))},i.prototype.subdivide=function(){var e,n,r=this.boundary.x,s=this.boundary.y,o=this.boundary.width/2,a=this.boundary.height/2,h=new t.Rectangle(r,s,o,a),u=new t.Rectangle(r+o,s,o,a),c=new t.Rectangle(r,s+a,o,a),l=new t.Rectangle(r+o,s+a,o,a);this.nw=new i(h,this.capacity,this.spatialHash.cellSize),this.ne=new i(u,this.capacity,this.spatialHash.cellSize),this.sw=new i(c,this.capacity,this.spatialHash.cellSize),this.se=new i(l,this.capacity,this.spatialHash.cellSize);try{for(var y=__values(this.aabbs),f=y.next();!f.done;f=y.next()){var p=f.value;this.nw.boundary.containsAABB(p)&&this.nw.insert(p),this.ne.boundary.containsAABB(p)&&this.ne.insert(p),this.sw.boundary.containsAABB(p)&&this.sw.insert(p),this.se.boundary.containsAABB(p)&&this.se.insert(p)}}catch(t){e={error:t}}finally{try{f&&!f.done&&(n=y.return)&&n.call(y)}finally{if(e)throw e.error}}this.aabbs=[],this.spatialHash.clear()},i.prototype.remove=function(t){return!!this.boundary.containsAABB(t)&&(!!this.spatialHash.remove(t)||null!==this.nw&&(this.nw.remove(t)||this.ne.remove(t)||this.sw.remove(t)||this.se.remove(t)))},i.prototype.query=function(t,i){return void 0===i&&(i=[]),this.boundary.intersects(t)?(i.push.apply(i,__spread(this.spatialHash.query(t.x,t.y))),null===this.nw?i:(this.nw.query(t,i),this.ne.query(t,i),this.sw.query(t,i),this.se.query(t,i),i)):i},i.prototype.queryPairs=function(){var t,i,e=[];if(this.nw){var n=this.nw.queryPairs(),r=this.ne.queryPairs(),s=this.sw.queryPairs(),o=this.se.queryPairs();e=e.concat(n,r,s,o)}else{var a=this.spatialHash.queryPairs();try{for(var h=__values(a),u=h.next();!u.done;u=h.next()){var c=u.value;e.push(c)}}catch(i){t={error:i}}finally{try{u&&!u.done&&(i=h.return)&&i.call(h)}finally{if(t)throw t.error}}}return e},i.prototype.update=function(t,i){return!!this.remove(t)&&(t.minX=i.minX,t.maxX=i.maxX,t.minY=i.minY,t.maxY=i.maxY,this.insert(t))},i}();t.QuadTree=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function t(t,i,e,n){this.x=t,this.y=i,this.width=e,this.height=n}return t.prototype.contains=function(t){return t.x>=this.x&&t.x<this.x+this.width&&t.y>=this.y&&t.y<this.y+this.height},t.prototype.intersects=function(t){return!(t.x>=this.x+this.width||t.x+t.width<=this.x||t.y>=this.y+this.height||t.y+t.height<=this.y)},t.prototype.containsAABB=function(t){return this.x<=t.minX&&this.x+this.width>=t.maxX&&this.y<=t.minY&&this.y+this.height>=t.maxY},t}();t.Rectangle=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function t(t){this.cellSize=t,this.buckets=new Map}return t.prototype.size=function(){var t,i,e=0;try{for(var n=__values(this.buckets.values()),r=n.next();!r.done;r=n.next()){e+=r.value.length}}catch(i){t={error:i}}finally{try{r&&!r.done&&(i=n.return)&&i.call(n)}finally{if(t)throw t.error}}return e},t.prototype.hash=function(t,i){return Math.floor(t/this.cellSize)+","+Math.floor(i/this.cellSize)},t.prototype.insert=function(t){for(var i=t.minX,e=t.minY,n=t.maxX,r=t.maxY,s=i;s<=n;s+=this.cellSize)for(var o=e;o<=r;o+=this.cellSize){var a=this.hash(s,o);this.buckets.has(a)||this.buckets.set(a,[]),this.buckets.get(a).push(t)}},t.prototype.remove=function(t){for(var i=t.minX,e=t.minY,n=t.maxX,r=t.maxY,s=!1,o=i;o<=n;o+=this.cellSize)for(var a=e;a<=r;a+=this.cellSize){var h=this.hash(o,a),u=this.buckets.get(h);if(u){var c=u.indexOf(t);-1!==c&&(u.splice(c,1),0===u.length&&this.buckets.delete(h),s=!0)}}return s},t.prototype.query=function(t,i){var e=this.hash(t,i);return this.buckets.get(e)||[]},t.prototype.queryPairs=function(){var t=[];return this.buckets.forEach(function(i,e){for(var n=0;n<i.length;n++)for(var r=n+1;r<i.length;r++)t.push([i[n],i[r]])}),t},t.prototype.clear=function(){this.buckets.clear()},t}();t.SpatialHash=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function t(){}return t.sweepAndPrune=function(t){var i,e,n,r,s=[];try{for(var o=__values(t),a=o.next();!a.done;a=o.next()){var h=a.value;s.push(h[0]),s.push(h[1])}}catch(t){i={error:t}}finally{try{a&&!a.done&&(e=o.return)&&e.call(o)}finally{if(i)throw i.error}}s.sort(function(t,i){return t.minX-i.minX});for(var u=[],c=[],l=function(t){var i,e,n=s[t],r=s[t+1],o=c.filter(function(t){return t.maxX>n.minX});try{for(var a=__values(o),h=a.next();!h.done;h=a.next()){var l=h.value;n.minY<=l.maxY&&n.maxY>=l.minY&&u.push([n,l])}}catch(t){i={error:t}}finally{try{h&&!h.done&&(e=a.return)&&e.call(a)}finally{if(i)throw i.error}}c.push(n),c=c.filter(function(t){return t.maxX>r.minX})},y=0;y<s.length-1;y++)l(y);var f=s[s.length-1],p=c.filter(function(t){return t.maxX>f.minX});try{for(var v=__values(p),m=v.next();!m.done;m=v.next()){var d=m.value;f.minY<=d.maxY&&f.maxY>=d.minY&&u.push([f,d])}}catch(t){n={error:t}}finally{try{m&&!m.done&&(r=v.return)&&r.call(v)}finally{if(n)throw n.error}}return u},t.mergeSort=function(t,i){if(t.length<=1)return t;var e=Math.floor(t.length/2),n=this.mergeSort(t.slice(0,e),i),r=this.mergeSort(t.slice(e),i);return this.merge(n,r,i)},t.merge=function(t,i,e){for(var n=[],r=0,s=0;r<t.length&&s<i.length;)e(t[r],i[s])<=0?(n.push(t[r]),r++):(n.push(i[s]),s++);return n.concat(t.slice(r)).concat(i.slice(s))},t}();t.SweepAndPrune=i}(t.physics||(t.physics={}))}(gs||(gs={})),function(t){!function(t){var i=function(){function t(){}return t.handleCollision=function(t,i){var e=t.computeCollisionTime(i),n=t.clone(),r=i.clone();return e<1&&(t.minX+=t.velocityX*e,t.minY+=t.velocityY*e,t.maxX+=t.velocityX*e,t.maxY+=t.velocityY*e,i.minX+=i.velocityX*e,i.minY+=i.velocityY*e,i.maxX+=i.velocityX*e,i.maxY+=i.velocityY*e),[n,r]},t.handleCollisions=function(t){for(var i,e,n=[],r=0;r<t.length;r++)for(var s=r+1;s<t.length;s++)n.push([t[r],t[s]]);for(var o=function(){var t,i,e=1/0,r=null;try{for(var s=__values(n),o=s.next();!o.done;o=s.next()){var a=o.value,h=a[0].computeCollisionTime(a[1]);h<e&&(e=h,r=a)}}catch(i){t={error:i}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}if(null===r)return"break";var u=__read(r,2),c=u[0],l=u[1];c.minX+=c.velocityX*e,c.minY+=c.velocityY*e,c.maxX+=c.velocityX*e,c.maxY+=c.velocityY*e,l.minX+=l.velocityX*e,l.minY+=l.velocityY*e,l.maxX+=l.velocityX*e,l.maxY+=l.velocityY*e;var y=(c.minX+c.maxX)/2-(l.minX+l.maxX)/2,f=(c.minY+c.maxY)/2-(l.minY+l.maxY)/2,p=Math.sqrt(y*y+f*f);y/=p,f/=p;var v=l.velocityX-c.velocityX,m=l.velocityY-c.velocityY,d=v*y+m*f;if(d>0){var x=2*d*y-v,b=2*d*f-m;c.velocityX-=x,c.velocityY-=b,l.velocityX+=x,l.velocityY+=b}n=n.filter(function(t){return t!==r})};;){if("break"===o())break}try{for(var a=__values(t),h=a.next();!h.done;h=a.next()){var u=h.value;u.minX+=u.velocityX,u.minY+=u.velocityY,u.maxX+=u.velocityX,u.maxY+=u.velocityY}}catch(t){i={error:t}}finally{try{h&&!h.done&&(e=a.return)&&e.call(a)}finally{if(i)throw i.error}}},t}();t.TimeBaseCollisionDetection=i}(t.physics||(t.physics={}))}(gs||(gs={}));