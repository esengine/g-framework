window.gs={},window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};!function(t){var e=function(){function t(t,e){this.createFn=t,this.resetFn=e,this.pool=[]}return t.prototype.acquire=function(){if(this.pool.length>0){var t=this.pool.pop();return this.resetFn(t),t}return this.createFn()},t.prototype.release=function(t){this.pool.push(t)},t}();t.ObjectPool=e}(gs||(gs={})),function(t){var e=function(e){function n(){return e.call(this,function(){return new t.Event("",null)},function(t){t.type="",t.data=null})||this}return __extends(n,e),n}(t.ObjectPool);t.EventPool=e}(gs||(gs={})),function(t){var e=function(){function e(){this.listeners=new Map,this.eventPool=new t.EventPool}return e.prototype.on=function(t,e){this.listeners.has(t)||this.listeners.set(t,[]);var n=this.listeners.get(t);n&&n.push(e)},e.prototype.once=function(t,e){var n=this,r=function(o){n.off(t,r),e(o)};this.on(t,r)},e.prototype.off=function(t,e){var n=this.listeners.get(t);if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},e.prototype.emit=function(t,e){var n,r,o=this.eventPool.acquire();o.type=t,o.data=e;var i=this.listeners[t];if(i)try{for(var a=__values(i),s=a.next();!s.done;s=a.next()){(0,s.value)(o)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}this.eventPool.release(o)},e}();t.EventEmitter=e}(gs||(gs={})),function(t){t.GlobalEventEmitter=new t.EventEmitter}(gs||(gs={})),function(t){var e=function(){function t(){this._entityId=null}return t.prototype.setEntityId=function(t){this._entityId=t},t.prototype.getEntityId=function(){return this._entityId},Object.defineProperty(t.prototype,"entityId",{get:function(){if(null===this._entityId)throw new Error("Entity ID 还未被设置");return this._entityId},enumerable:!0,configurable:!0}),t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(Object.keys(this)),o=r.next();!o.done;o=r.next()){var i=o.value,a=this[i];"function"!=typeof a&&(n[i]=a)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){for(var e in t)void 0!==this[e]&&(this[e]=t[e])},t}();t.Component=e}(gs||(gs={})),function(t){var e=function(){function e(e,n){this.id=e,this.componentManagers=n,this.tags=new Set,this.eventEmitter=new t.EventEmitter}return e.prototype.getId=function(){return this.id},e.prototype.addComponent=function(t){var e=this.componentManagers.get(t);if(!e)throw new Error("组件类型为 "+t.name+" 的组件管理器未找到.");return e.create(this.id)},e.prototype.getComponent=function(t){var e=this.componentManagers.get(t);return e?e.get(this.id):null},e.prototype.removeComponent=function(t){var e=this.componentManagers.get(t);e&&(this.getComponent(t)&&e.remove(this.id))},e.prototype.hasComponent=function(t){var e=this.componentManagers.get(t);return!!e&&e.has(this.id)},e.prototype.addTag=function(t){this.tags.add(t)},e.prototype.getTags=function(){return this.tags},e.prototype.removeTag=function(t){this.tags.delete(t)},e.prototype.hasTag=function(t){return this.tags.has(t)},e.prototype.serialize=function(){var t,e,n={id:this.id,components:{}};try{for(var r=__values(this.componentManagers),o=r.next();!o.done;o=r.next()){var i=__read(o.value,2),a=i[0],s=i[1].get(this.id);s&&(n.components[a.name]=s.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},e.prototype.deserialize=function(t){var e,n;for(var r in t.components)try{for(var o=__values(this.componentManagers),i=o.next();!i.done;i=o.next()){var a=__read(i.value,2),s=a[0],u=a[1];if(s.name===r){var p=u.get(this.id);p&&p.deserialize(t.components[r]);break}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}},e.prototype.onCreate=function(){},e.prototype.onDestroy=function(){},e.prototype.on=function(t,e){this.eventEmitter.on(t,e)},e.prototype.once=function(t,e){this.eventEmitter.once(t,e)},e.prototype.off=function(t,e){this.eventEmitter.off(t,e)},e.prototype.emit=function(t,e){this.eventEmitter.emit(t,e)},e}();t.Entity=e}(gs||(gs={})),function(t){var e=function(){function t(t,e,n){this.paused=!1,this.enabled=!0,this.entityManager=t,this.priority=e,this.workerScript=n}return t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1},t.prototype.isPaused=function(){return this.paused},t.prototype.enable=function(){this.enabled=!0},t.prototype.disable=function(){this.enabled=!1},t.prototype.isEnabled=function(){return this.enabled},t.prototype.onRegister=function(){},t.prototype.onUnregister=function(){},t}();t.System=e}(gs||(gs={})),function(t){var e=function(){return function(t,e){this.type=t,this.data=e}}();t.Event=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.inputManager=t}return t.prototype.sendInputToManager=function(t){this.inputManager.sendInput(t)},t}();t.InputAdapter=e}(gs||(gs={})),function(t){var e=function(){function t(){this.buffer=[]}return t.prototype.addEvent=function(t){this.buffer.push(t)},t.prototype.hasEvents=function(){return this.buffer.length>0},t.prototype.getEvents=function(){return this.buffer},t.prototype.consumeEvent=function(){if(0===this.buffer.length)return null;var t=this.buffer[0];return this.buffer.shift(),t},t.prototype.clear=function(){this.buffer=[]},t}();t.InputBuffer=e}(gs||(gs={})),function(t){var e=function(){function e(e){this.inputHistory=[],this.entityManager=e,this.inputBuffer=new t.InputBuffer}return e.prototype.setAdapter=function(t){this.adapter=t},e.prototype.sendInput=function(t){this.handleInput(t)},e.prototype.handleInput=function(t){this.inputBuffer.addEvent(t),this.inputHistory.push({frameNumber:this.getCurrentFrameNumber(),input:t})},e.prototype.getCurrentFrameNumber=function(){return this.entityManager.getCurrentFrameNumber()},e.prototype.getInputBuffer=function(){return this.inputBuffer},e.prototype.getInputHistory=function(){return this.inputHistory},e}();t.InputManager=e}(gs||(gs={})),function(t){!function(t){t[t.KEY_DOWN=0]="KEY_DOWN",t[t.KEY_UP=1]="KEY_UP",t[t.MOUSE_DOWN=2]="MOUSE_DOWN",t[t.MOUSE_UP=3]="MOUSE_UP",t[t.MOUSE_MOVE=4]="MOUSE_MOVE"}(t.InputType||(t.InputType={}))}(gs||(gs={})),function(t){var e=function(){function t(t){this.data=[],this.entityToDataIndex=new Map,this.freeDataIndices=[],this.componentPool=[],this.componentType=t}return t.prototype.create=function(t){var e,n=this.allocateDataIndex();return(e=this.componentPool.length>0?this.componentPool.pop():new this.componentType).setEntityId(t),this.data[n]=e,this.entityToDataIndex.set(t,n),e},t.prototype.get=function(t){var e=this.entityToDataIndex.get(t);return void 0===e?null:(this.data[e]||(this.data[e]={}),this.data[e])},t.prototype.has=function(t){return this.entityToDataIndex.has(t)},t.prototype.remove=function(t){var e=this.entityToDataIndex.get(t);if(void 0!==e){this.entityToDataIndex.delete(t);var n=this.data[e];n.reset(),this.data[e]=null,this.freeDataIndices.push(e),this.componentPool.push(n)}},t.prototype.allocateDataIndex=function(){return this.freeDataIndices.length>0?this.freeDataIndices.pop():this.data.length},t}();t.ComponentManager=e}(gs||(gs={})),function(t){var e=function(){function e(e){var n,r;if(void 0===e&&(e=null),this.queryCache=new Map,this.tagCache=new Map,this.entities=new Map,this.entityIdAllocator=new t.EntityIdAllocator,this.inputManager=new t.InputManager(this),this.networkManager=new t.NetworkManager,this.currentFrameNumber=0,this.componentManagers=new Map,null!=e)try{for(var o=__values(e),i=o.next();!i.done;i=o.next()){var a=i.value,s=new t.ComponentManager(a);this.componentManagers.set(a,s)}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}}return e.prototype.addComponentManager=function(e){var n=new t.ComponentManager(e);this.componentManagers.set(e,n)},e.prototype.updateFrameNumber=function(){this.currentFrameNumber++},e.prototype.getCurrentFrameNumber=function(){return this.currentFrameNumber},e.prototype.getInputManager=function(){return this.inputManager},e.prototype.getNetworkManager=function(){return this.networkManager},e.prototype.createEntity=function(){var e,n,r=this.entityIdAllocator.allocate(),o=new t.Entity(r,this.componentManagers);o.onCreate(),this.entities.set(r,o);try{for(var i=__values(o.getTags()),a=i.next();!a.done;a=i.next()){var s=a.value;this.tagCache.has(s)||this.tagCache.set(s,[]),this.tagCache.has(s)&&this.tagCache.get(s).push(o)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return o},e.prototype.deleteEntity=function(t){var e,n,r=this.getEntity(t);if(r){r.onDestroy(),this.entities.delete(t);try{for(var o=__values(r.getTags()),i=o.next();!i.done;i=o.next()){var a=i.value,s=this.tagCache.get(a);if(s){var u=s.indexOf(r);u>-1&&s.splice(u,1)}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}}},e.prototype.getEntity=function(t){return this.entities.has(t)?this.entities.get(t):null},e.prototype.getEntitiesWithComponent=function(t){return this.queryComponents([t])},e.prototype.getEntitiesWithComponents=function(t){return this.queryComponents(t)},e.prototype.getEntities=function(){return Array.from(this.entities.values())},e.prototype.getEntitiesWithTag=function(t){var e,n;if(!this.tagCache.has(t)){var r=[];try{for(var o=__values(this.getEntities()),i=o.next();!i.done;i=o.next()){var a=i.value;a.hasTag(t)&&r.push(a)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}this.tagCache.set(t,r)}return this.tagCache.get(t)},e.prototype.queryComponents=function(t){var e=t.map(function(t){return t.name}).sort().join("|");if(!this.queryCache.has(e)){var n=this.performQuery(t);this.queryCache.set(e,n)}return this.queryCache.get(e)},e.prototype.performQuery=function(t){var e,n,r=[],o=function(e){t.every(function(t){return e.hasComponent(t)})&&r.push(e)};try{for(var i=__values(this.getEntities()),a=i.next();!a.done;a=i.next()){o(a.value)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},e.prototype.createStateSnapshot=function(){var t,e,n={entities:[]};try{for(var r=__values(this.getEntities()),o=r.next();!o.done;o=r.next()){var i=o.value;n.entities.push(i.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},e.prototype.updateStateFromSnapshot=function(e){var n,r,o=new Map;try{for(var i=__values(e.entities),a=i.next();!a.done;a=i.next()){var s=a.value,u=s.id,p=this.getEntity(u);p||(p=new t.Entity(u,this.componentManagers)).onCreate(),p.deserialize(s),o.set(u,p)}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}this.entities=o},e.prototype.applyInterpolation=function(e){var n,r,o,i;try{for(var a=__values(this.getEntities()),s=a.next();!s.done;s=a.next()){var u=s.value;try{for(var p=__values(this.componentManagers),c=p.next();!c.done;c=p.next()){var h=__read(c.value,2),f=h[0],l=(h[1],u.getComponent(f));l instanceof t.Component&&"savePreviousState"in l&&"applyInterpolation"in l&&l.applyInterpolation(e)}}catch(t){o={error:t}}finally{try{c&&!c.done&&(i=p.return)&&i.call(p)}finally{if(o)throw o.error}}}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}},e}();t.EntityManager=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.systemWorkers=new Map,this.systems=[],this.entityManager=t}return t.prototype.registerSystem=function(t){if(t.onRegister(),this.systems.push(t),this.systems.sort(function(t,e){return t.priority-e.priority}),t.workerScript)if("undefined"==typeof Worker)console.warn("Web Workers 在当前环境中不受支持。系统将在主线程中运行");else{var e=new Worker(t.workerScript);this.systemWorkers.set(t,e)}},t.prototype.unregisterSystem=function(t){t.onUnregister();var e=this.systems.indexOf(t);e>-1&&this.systems.splice(e,1)},t.prototype.update=function(){var t,e,n=this,r=this.entityManager.getEntities(),o=function(t){if(!t.isEnabled()||t.isPaused())return"continue";var e=r.filter(function(e){return t.entityFilter(e)}),o=i.systemWorkers.get(t);if(o){var a={entities:e.map(function(t){return t.serialize()})};o.postMessage(a),o.onmessage=function(t){var e,r,o=t.data.entities;try{for(var i=__values(o),a=i.next();!a.done;a=i.next()){var s=a.value,u=n.entityManager.getEntity(s.id);u&&u.deserialize(s)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}}else t.update(e)},i=this;try{for(var a=__values(this.systems),s=a.next();!s.done;s=a.next()){o(s.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}},t}();t.SystemManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.deltaTime=0,this.timeScale=1,this.totalTime=0}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.update=function(t){this.deltaTime=t*this.timeScale,this.totalTime+=this.deltaTime},t}();t.TimeManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.networkAdapter=null}return t.prototype.setNetworkAdapter=function(t){this.networkAdapter=t},t.prototype.getNetworkAdpater=function(){return this.networkAdapter},t}();t.NetworkManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.currentState=null,this.states=new Map}return t.prototype.addState=function(t,e){this.states.set(t,e)},t.prototype.changeState=function(t){if(this.states.has(t)){var e=this.states.get(t);this.currentState&&this.currentState.exit&&this.currentState.exit(),this.currentState=e,this.currentState.enter&&this.currentState.enter()}else console.warn('状态 "'+t+'" 不存在.')},t.prototype.update=function(){this.currentState&&this.currentState.update&&this.currentState.update()},t}();t.StateMachine=e}(gs||(gs={})),function(t){var e=function(e){function n(){var n=e.call(this)||this;return n.stateMachine=new t.StateMachine,n}return __extends(n,e),n.prototype.reset=function(){this.stateMachine=new t.StateMachine},n}(t.Component);t.StateMachineComponent=e}(gs||(gs={})),function(t){var e=function(e){function n(t){return e.call(this,t,1)||this}return __extends(n,e),n.prototype.entityFilter=function(e){return e.hasComponent(t.StateMachineComponent)},n.prototype.update=function(e){var n,r;try{for(var o=__values(e),i=o.next();!i.done;i=o.next()){i.value.getComponent(t.StateMachineComponent).stateMachine.update()}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}},n}(t.System);t.StateMachineSystem=e}(gs||(gs={})),function(t){var e=function(){function t(){this.nextId=0}return t.prototype.allocate=function(){var t=this.nextId;return this.nextId+=1,t},t}();t.EntityIdAllocator=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.seed=t}return t.prototype.next=function(){return this.seed=(9301*this.seed+49297)%233280,this.seed/233280},t.prototype.nextInt=function(t,e){return t+Math.floor(this.next()*(e-t))},t.prototype.nextFloat=function(t,e){return t+this.next()*(e-t)},t.prototype.choose=function(t){return t[this.nextInt(0,t.length)]},t}();t.Random=e}(gs||(gs={}));