window.gs={};var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),function(t){var e=function(){function t(){}return t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(Object.keys(this)),o=r.next();!o.done;o=r.next()){var i=o.value,a=this[i];"function"!=typeof a&&(n[i]=a)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){for(var e in t)void 0!==this[e]&&(this[e]=t[e])},t.registerComponent=function(t,e){for(var n=new t,r=Object.keys(n),o=function(n){var o=r[n],i=Object.getOwnPropertyDescriptor(t.prototype,o);if(i&&"function"==typeof i.get&&"function"==typeof i.set){var a=e.allocateDataIndex();Object.defineProperty(t.prototype,o,{get:function(){return e.get(this.entityId)[a]},set:function(t){e.get(this.entityId)[a]=t},enumerable:!0,configurable:!0})}},i=0;i<r.length;i++)o(i)},t}();t.Component=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.data=[],this.entityToDataIndex=new Map,this.freeDataIndices=[],this.componentType=t}return t.prototype.create=function(t){var e=this.allocateDataIndex(),n=new this.componentType(t);return this.data[e]=n,this.entityToDataIndex.set(t,e),n},t.prototype.get=function(t){var e=this.entityToDataIndex.get(t);return void 0===e?null:this.data[e]},t.prototype.has=function(t){return this.entityToDataIndex.has(t)},t.prototype.remove=function(t){var e=this.entityToDataIndex.get(t);void 0!==e&&(this.entityToDataIndex.delete(t),this.data[e]=null,this.freeDataIndices.push(e))},t.prototype.allocateDataIndex=function(){return this.freeDataIndices.length>0?this.freeDataIndices.pop():this.data.length},t}();t.ComponentManager=e}(gs||(gs={})),function(t){var e=function(){function t(t,e){this.id=t,this.componentManagers=e}return t.prototype.getId=function(){return this.id},t.prototype.addComponent=function(t){var e=this.componentManagers.get(t);if(!e)throw new Error("组件类型为 "+t.name+" 的组件管理器未找到.");return e.create(this.id)},t.prototype.getComponent=function(t){var e=this.componentManagers.get(t);return e?e.get(this.id):null},t.prototype.removeComponent=function(t){var e=this.componentManagers.get(t);e&&e.remove(this.id)},t.prototype.hasComponent=function(t){var e=this.componentManagers.get(t);return!!e&&e.has(this.id)},t.prototype.serialize=function(){var t,e,n={id:this.id,components:{}};try{for(var r=__values(this.componentManagers),o=r.next();!o.done;o=r.next()){var i=__read(o.value,2),a=i[0],s=i[1].get(this.id);s&&(n.components[a.name]=s.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){var e,n;for(var r in t.components)try{for(var o=__values(this.componentManagers),i=o.next();!i.done;i=o.next()){var a=__read(i.value,2),s=a[0],u=a[1];if(s.name===r){var c=u.get(this.id);c&&c.deserialize(t.components[r]);break}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}},t}();t.Entity=e}(gs||(gs={})),function(t){var e=function(){function t(){this.nextId=0}return t.prototype.allocate=function(){var t=this.nextId;return this.nextId+=1,t},t}();t.EntityIdAllocator=e}(gs||(gs={})),function(t){var e=function(){function e(){this.entities=new Map,this.entityIdAllocator=new t.EntityIdAllocator}return e.prototype.createEntity=function(){var e=this.entityIdAllocator.allocate(),n=new Map;return new t.Entity(e,n)},e.prototype.deleteEntity=function(t){this.entities.delete(t)},e.prototype.getEntity=function(t){return this.entities.has(t)?this.entities.get(t):null},e.prototype.getEntitiesWithComponent=function(t){var e,n,r=[];try{for(var o=__values(this.getEntities()),i=o.next();!i.done;i=o.next()){var a=i.value;a.hasComponent(t)&&r.push(a)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}return r},e.prototype.getEntities=function(){return Array.from(this.entities.values())},e}();t.EntityManager=e}(gs||(gs={})),function(t){var e=function(){return function(t,e){this.type=t,this.data=e}}();t.Event=e;var n=function(){function e(){this.listeners=new Map,this.eventPool=new t.EventPool}return e.prototype.on=function(t,e){this.listeners.has(t)||this.listeners.set(t,[]);var n=this.listeners.get(t);n&&n.push(e)},e.prototype.once=function(t,e){var n=this,r=function(o){n.off(t,r),e(o)};this.on(t,r)},e.prototype.off=function(t,e){var n=this.listeners.get(t);if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},e.prototype.emit=function(t,e){var n,r,o=this.eventPool.acquire();o.type=t,o.data=e;var i=this.listeners[t];if(i)try{for(var a=__values(i),s=a.next();!s.done;s=a.next()){(0,s.value)(o)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}this.eventPool.release(o)},e}();t.EventEmitter=n}(gs||(gs={})),function(t){var e=function(){function t(t,e){this.createFn=t,this.resetFn=e,this.pool=[]}return t.prototype.acquire=function(){if(this.pool.length>0){var t=this.pool.pop();return this.resetFn(t),t}return this.createFn()},t.prototype.release=function(t){this.pool.push(t)},t}();t.ObjectPool=e}(gs||(gs={})),function(t){var e=function(e){function n(){return e.call(this,function(){return new t.Event("",null)},function(t){t.type="",t.data=null})||this}return __extends(n,e),n}(t.ObjectPool);t.EventPool=e}(gs||(gs={})),function(t){t.GlobalEventEmitter=new t.EventEmitter}(gs||(gs={})),function(t){var e=function(){return function(t,e,n){this.entityManager=t,this.priority=e,this.workerScript=n}}();t.System=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.systemWorkers=new Map,this.systems=[],this.entityManager=t}return t.prototype.registerSystem=function(t){if(this.systems.push(t),this.systems.sort(function(t,e){return t.priority-e.priority}),t.workerScript)if("undefined"==typeof Worker)console.warn("Web Workers 在当前环境中不受支持。系统将在主线程中运行");else{var e=new Worker(t.workerScript);this.systemWorkers.set(t,e)}},t.prototype.update=function(t){var e,n,r=this,o=this.entityManager.getEntities(),i=function(e){var n=o.filter(function(t){return e.entityFilter(t)}),i=a.systemWorkers.get(e);if(i){var s={deltaTime:t,entities:n.map(function(t){return t.serialize()})};i.postMessage(s),i.onmessage=function(t){var e,n,o=t.data.entities;try{for(var i=__values(o),a=i.next();!a.done;a=i.next()){var s=a.value,u=r.entityManager.getEntity(s.id);u&&u.deserialize(s)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}}}else e.update(t,n)},a=this;try{for(var s=__values(this.systems),u=s.next();!u.done;u=s.next()){i(u.value)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}},t}();t.SystemManager=e}(gs||(gs={})),function(t){var e=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.x=0,t.y=0,t.rotation=0,t.scaleX=1,t.scaleY=1,t}return __extends(n,e),n.prototype.do=function(){var e=new t.EntityManager,r=new t.ComponentManager(n);t.Component.registerComponent(n,r);var o=e.createEntity(),i=r.create(o.getId());i.x=10,i.y=20;var a=r.get(o.getId());console.log(a.x,a.y)},n}(t.Component);t.TransformComponent=e}(gs||(gs={}));