window.gs={},window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},__spread=this&&this.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t};!function(t){var e=function(){function t(t,e){this.createFn=t,this.resetFn=e,this.pool=[]}return t.prototype.acquire=function(){if(this.pool.length>0){var t=this.pool.pop();return this.resetFn(t),t}return this.createFn()},t.prototype.release=function(t){this.pool.push(t)},t}();t.ObjectPool=e}(gs||(gs={})),function(t){var e=function(e){function n(){return e.call(this,function(){return new t.Event("",null)},function(t){t.type="",t.data=null})||this}return __extends(n,e),n}(t.ObjectPool);t.EventPool=e}(gs||(gs={})),function(t){var e=function(){function e(){this.listeners=new Map,this.eventPool=new t.EventPool}return e.prototype.on=function(t,e){this.listeners.has(t)||this.listeners.set(t,[]);var n=this.listeners.get(t);n&&n.push(e)},e.prototype.once=function(t,e){var n=this,r=function(o){n.off(t,r),e(o)};this.on(t,r)},e.prototype.off=function(t,e){var n=this.listeners.get(t);if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},e.prototype.emit=function(t,e){var n,r,o=this.eventPool.acquire();o.type=t,o.data=e;var i=this.listeners[t];if(i)try{for(var a=__values(i),s=a.next();!s.done;s=a.next()){(0,s.value)(o)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}this.eventPool.release(o)},e}();t.EventEmitter=e}(gs||(gs={})),function(t){t.GlobalEventEmitter=new t.EventEmitter}(gs||(gs={})),function(t){var e=function(){function t(){this._entityId=null,this._version=0,this.dependencies=[]}return t.prototype.setEntityId=function(t,e){this._entityId=t,this._entityManager=e},t.prototype.getEntityId=function(){return this._entityId},Object.defineProperty(t.prototype,"entityId",{get:function(){if(null===this._entityId)throw new Error("Entity ID 还未被设置");return this._entityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entity",{get:function(){if(null===this._entityId)throw new Error("Entity ID 还未被设置");return this._entityManager.getEntity(this._entityId)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._version},enumerable:!0,configurable:!0}),t.prototype.markUpdated=function(){this._version++},t.prototype.reinitialize=function(t,e){},t.prototype.onInitialize=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},t.prototype.onAdded=function(){},t.prototype.onRemoved=function(){},t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(Object.keys(this)),o=r.next();!o.done;o=r.next()){var i=o.value,a=this[i];"function"!=typeof a&&(n[i]=a)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){for(var e in t)void 0!==this[e]&&(this[e]=t[e])},t.prototype.shouldSerialize=function(){return!0},t.prototype.reset=function(){this._entityId=null},t.prototype.cloneShallow=function(){var t=new this.constructor;for(var e in this)this.hasOwnProperty(e)&&(t[e]=this[e]);return t},t.prototype.cloneDeep=function(){var t=new this.constructor;for(var e in this)if(this.hasOwnProperty(e)){var n=this[e];t[e]="object"==typeof n&&null!==n?this.deepCopy(n):n}return t},t.prototype.deepCopy=function(t){var e=this;if(Array.isArray(t))return t.map(function(t){return e.deepCopy(t)});if("object"==typeof t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=this.deepCopy(t[r]));return n}return t},t}();t.Component=e}(gs||(gs={})),function(t){var e=function(){function e(e,n,r){this.componentCache=new Map,this.id=e,this.componentManagers=r,this.tags=new Set,this.eventEmitter=new t.EventEmitter,this.entityManager=n,this.componentBits=new t.Bits}return e.prototype.getId=function(){return this.id},e.prototype.addComponent=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=this.componentManagers.get(e);if(!o)throw new Error("组件类型为 "+e.name+" 的组件管理器未找到.");var i=o.create(this.id,this.entityManager);i.onInitialize.apply(i,__spread(n));var a=t.ComponentTypeManager.getIndexFor(e);return this.componentBits.set(a),this.entityManager.systemManager&&this.entityManager.systemManager.notifyComponentAdded(this),this.entityManager.invalidateCache(e),i},e.prototype.getComponent=function(t){var e=this.componentCache.get(t);if(e)return e;var n=this.componentManagers.get(t);if(!n)return null;var r=n.get(this.id);return r&&this.componentCache.set(t,r),r},e.prototype.getAllComponents=function(){var t=this;return Array.from(this.componentManagers.values()).map(function(e){return e.get(t.id)}).filter(function(t){return null!==t})},e.prototype.removeComponent=function(e){var n=this.componentManagers.get(e);if(n){this.getComponent(e)&&(this.entityManager.systemManager&&this.entityManager.systemManager.notifyComponentRemoved(this),n.remove(this.id));var r=t.ComponentTypeManager.getIndexFor(e);this.componentBits.clear(r),this.componentCache.delete(e),this.entityManager.invalidateCache(e)}},e.prototype.hasComponent=function(t){var e=this.componentManagers.get(t);return!!e&&e.has(this.id)},e.prototype.clearComponentCache=function(){this.componentCache.clear()},e.prototype.addTag=function(t){this.tags.add(t),this.entityManager.invalidateCache(void 0,t)},e.prototype.getTags=function(){return new Set(Array.from(this.tags))},e.prototype.removeTag=function(t){this.tags.delete(t),this.entityManager.invalidateCache(void 0,t)},e.prototype.hasTag=function(t){return this.tags.has(t)},e.prototype.serialize=function(){var t,e,n={id:this.id,components:{}};try{for(var r=__values(this.componentManagers),o=r.next();!o.done;o=r.next()){var i=__read(o.value,2),a=i[0],s=i[1].get(this.id);s&&s.shouldSerialize()&&(n.components[a.name]=s.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},e.prototype.serializeIncremental=function(t){var e,n,r=!1,o={id:this.id,components:{}};try{for(var i=__values(this.componentManagers),a=i.next();!a.done;a=i.next()){var s=__read(a.value,2),u=s[0],p=s[1].get(this.id);p&&p.shouldSerialize()&&p.version>t&&(o.components[u.name]=p.serialize(),r=!0)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r?o:null},e.prototype.deserialize=function(t){var e,n;for(var r in t.components)try{for(var o=__values(this.componentManagers),i=o.next();!i.done;i=o.next()){var a=__read(i.value,2),s=a[0],u=a[1];if(s.name===r){var p=u.get(this.id);p&&p.deserialize(t.components[r]);break}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}},e.prototype.onCreate=function(){},e.prototype.onDestroy=function(){},e.prototype.on=function(t,e){this.eventEmitter.on(t,e)},e.prototype.once=function(t,e){this.eventEmitter.once(t,e)},e.prototype.off=function(t,e){this.eventEmitter.off(t,e)},e.prototype.emit=function(t,e){this.eventEmitter.emit(t,e)},e}();t.Entity=e}(gs||(gs={})),function(t){var e=function(){function e(e,n,r,o){this._paused=!1,this._enabled=!0,this.entityManager=e,this.priority=n,this.workerScript=o,this.matcher=r||t.Matcher.empty()}return Object.defineProperty(e.prototype,"paused",{get:function(){return this._paused},set:function(t){this._paused=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),e.prototype.isPaused=function(){return this.paused},e.prototype.isEnabled=function(){return this.enabled},e.prototype.entityFilter=function(t){return!0},e.prototype.filterEntities=function(t){var e=this;return t.reduce(function(t,n){return e.matcher.isInterestedEntity(n)&&e.entityFilter(n)&&t.push(n),t},[])},e.prototype.handleComponentChange=function(t,e){this.matcher.isInterestedEntity(t)&&(e?this.onComponentAdded(t):this.onComponentRemoved(t))},e.prototype.onComponentAdded=function(t){},e.prototype.onComponentRemoved=function(t){},e.prototype.onRegister=function(){},e.prototype.onUnregister=function(){},e}();t.System=e}(gs||(gs={})),function(t){var e=function(){return function(t,e){this.type=t,this.data=e}}();t.Event=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.inputManager=t}return t.prototype.sendInputToManager=function(t){this.inputManager.sendInput(t)},t}();t.InputAdapter=e}(gs||(gs={})),function(t){var e=function(){function t(){this.buffer=[]}return t.prototype.addEvent=function(t){this.buffer.push(t)},t.prototype.hasEvents=function(){return this.buffer.length>0},t.prototype.getEvents=function(){return this.buffer},t.prototype.consumeEvent=function(){if(0===this.buffer.length)return null;var t=this.buffer[0];return this.buffer.shift(),t},t.prototype.clear=function(){this.buffer=[]},t}();t.InputBuffer=e}(gs||(gs={})),function(t){var e=function(){function e(e){this.inputHistory=[],this.historySizeThreshold=1e3,this.eventListeners=[],this.entityManager=e,this.inputBuffer=new t.InputBuffer}return e.prototype.setHistorySizeThreshold=function(t){this.historySizeThreshold=t},e.prototype.addEventListener=function(t){this.eventListeners.push(t)},e.prototype.setAdapter=function(t){this.adapter=t},e.prototype.sendInput=function(t){this.handleInput(t)},e.prototype.handleInput=function(t){this.inputBuffer.addEvent(t),this.inputHistory.push({frameNumber:this.getCurrentFrameNumber(),input:t}),this.eventListeners.forEach(function(e){return e(t)}),this.inputHistory.length>this.historySizeThreshold&&this.inputHistory.splice(0,this.inputHistory.length-this.historySizeThreshold)},e.prototype.getCurrentFrameNumber=function(){return this.entityManager.getCurrentFrameNumber()},e.prototype.getInputBuffer=function(){return this.inputBuffer},e.prototype.getInputHistory=function(){return this.inputHistory},e}();t.InputManager=e}(gs||(gs={})),function(t){var e=function(){function e(e){this.componentPool=[],this.componentType=e,this.components=new t.SparseSet,this.preallocate(10)}return e.prototype.create=function(t,e){var n,r,o;this.componentPool.length>0?(o=this.componentPool.pop()).reinitialize(t,e):o=new this.componentType,o.setEntityId(t,e);try{for(var i=__values(o.dependencies),a=i.next();!a.done;a=i.next()){var s=a.value;if(!e.hasComponent(t,s))throw new Error("组件 "+o.constructor.name+" 依赖于 "+s.name+"，但实体 "+t+" 缺少该组件。")}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return this.components.add(t,o),o},e.prototype.get=function(t){return this.components.get(t)},e.prototype.has=function(t){return this.components.has(t)},e.prototype.remove=function(t){var e=this.components.get(t);e&&(e.reset(),this.componentPool.push(e)),this.components.remove(t)},e.prototype.preallocate=function(t,e){void 0===e&&(e=!0);for(var n=0;n<t;n++){var r=new this.componentType;e&&r.reset(),this.componentPool.push(r)}},e}();t.ComponentManager=e}(gs||(gs={})),function(t){var e=function(){function t(){}return t.getIndexFor=function(t){var e=this.componentTypes.get(t);return void 0===e&&(e=this.nextIndex++,this.componentTypes.set(t,e)),e},t.componentTypes=new Map,t.nextIndex=0,t}();t.ComponentTypeManager=e}(gs||(gs={})),function(t){var e=function(){function e(e,n){var r,o;if(void 0===e&&(e=null),this.queryCache=new Map,this.tagToEntities=new Map,this.prefabs=new Map,this.entities=new Map,this.entityIdAllocator=new t.EntityIdAllocator,this.inputManager=new t.InputManager(this),this.networkManager=new t.NetworkManager,this.currentFrameNumber=0,this.systemManager=n,this.componentManagers=new Map,null!=e)try{for(var i=__values(e),a=i.next();!a.done;a=i.next()){var s=a.value,u=new t.ComponentManager(s);this.componentManagers.set(s,u)}}catch(t){r={error:t}}finally{try{a&&!a.done&&(o=i.return)&&o.call(i)}finally{if(r)throw r.error}}}return e.prototype.setSystemManager=function(t){this.systemManager=t},e.prototype.addComponentManager=function(e){var n=new t.ComponentManager(e);this.componentManagers.set(e,n)},e.prototype.updateFrameNumber=function(){this.currentFrameNumber++},e.prototype.getCurrentFrameNumber=function(){return this.currentFrameNumber},e.prototype.getInputManager=function(){return this.inputManager},e.prototype.getNetworkManager=function(){return this.networkManager},e.prototype.createEntity=function(e){var n,r;void 0===e&&(e=t.Entity);var o=this.entityIdAllocator.allocate(),i=new e(o,this,this.componentManagers);i.onCreate(),this.entities.set(o,i);try{for(var a=__values(i.getTags()),s=a.next();!s.done;s=a.next()){var u=s.value;this.addToTagCache(u,i)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}return i},e.prototype.deleteEntity=function(t){var e,n,r=this.getEntity(t);if(r){r.onDestroy(),this.entities.delete(t);try{for(var o=__values(r.getTags()),i=o.next();!i.done;i=o.next()){var a=i.value;this.removeFromTagCache(a,r)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}}},e.prototype.createEntityFromPrefab=function(t,e){void 0===e&&(e=!1);var n=this.prefabs.get(t);return n?this.cloneEntity(n,e):(console.warn('找不到名称为 "'+t+'" 的预制件'),null)},e.prototype.registerPrefab=function(t,e){this.prefabs.has(t)&&console.warn('名称为 "'+t+'" 的预制件已存在。正在覆盖...'),this.prefabs.set(t,e)},e.prototype.unregisterPrefab=function(t){this.prefabs.has(t)?this.prefabs.delete(t):console.warn('名称为 "'+t+'" 的预制件不存在')},e.prototype.getEntity=function(t){return this.entities.has(t)?this.entities.get(t):null},e.prototype.getEntitiesWithComponent=function(t){return this.queryComponents([t])},e.prototype.getEntitiesWithComponents=function(t){return this.queryComponents(t)},e.prototype.getEntities=function(){return Array.from(this.entities.values())},e.prototype.getEntitiesWithTag=function(t){return this.tagToEntities.get(t)||[]},e.prototype.hasComponent=function(t,e){var n=this.componentManagers.get(e);return!!n&&n.has(t)},e.prototype.queryComponents=function(t){var e=""+t.map(function(t){return t.name}).sort().join("|");if(!this.queryCache.has(e)){var n=this.performQuery(t);this.queryCache.set(e,n)}return this.queryCache.get(e)},e.prototype.performQuery=function(t){var e,n,r=[],o=function(e){t.every(function(t){return e.hasComponent(t)})&&r.push(e)};try{for(var i=__values(this.getEntities()),a=i.next();!a.done;a=i.next()){o(a.value)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},e.prototype.createStateSnapshot=function(){var t,e,n={entities:[]};try{for(var r=__values(this.getEntities()),o=r.next();!o.done;o=r.next()){var i=o.value;n.entities.push(i.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},e.prototype.createIncrementalStateSnapshot=function(t){var e,n,r={entities:[]};try{for(var o=__values(this.getEntities()),i=o.next();!i.done;i=o.next()){var a=i.value.serializeIncremental(t);a&&r.entities.push(a)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}return r},e.prototype.updateStateFromSnapshot=function(e){var n,r,o=new Map;try{for(var i=__values(e.entities),a=i.next();!a.done;a=i.next()){var s=a.value,u=s.id,p=this.getEntity(u);p||(p=new t.Entity(u,this,this.componentManagers)).onCreate(),p.deserialize(s),o.set(u,p)}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}this.entities=o},e.prototype.applyInterpolation=function(e){var n,r,o,i;try{for(var a=__values(this.getEntities()),s=a.next();!s.done;s=a.next()){var u=s.value;try{for(var p=__values(this.componentManagers),h=p.next();!h.done;h=p.next()){var c=__read(h.value,2),f=c[0],l=(c[1],u.getComponent(f));l instanceof t.Component&&"savePreviousState"in l&&"applyInterpolation"in l&&l.applyInterpolation(e)}}catch(t){o={error:t}}finally{try{h&&!h.done&&(i=p.return)&&i.call(p)}finally{if(o)throw o.error}}}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}},e.prototype.invalidateCache=function(t,e){if(t){var n=t.name;this.queryCache.delete(n)}e&&this.tagToEntities.delete(e)},e.prototype.cloneEntity=function(t,e){var n,r,o,i;void 0===e&&(e=!1);var a=this.createEntity(t.constructor);try{for(var s=__values(this.componentManagers),u=s.next();!u.done;u=s.next()){var p=__read(u.value,2),h=p[0],c=(p[1],t.getComponent(h));if(c){var f=e?c.cloneDeep():c.cloneShallow();a.addComponent(h,f)}}}catch(t){n={error:t}}finally{try{u&&!u.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}try{for(var l=__values(t.getTags()),y=l.next();!y.done;y=l.next()){var d=y.value;a.addTag(d)}}catch(t){o={error:t}}finally{try{y&&!y.done&&(i=l.return)&&i.call(l)}finally{if(o)throw o.error}}return a},e.prototype.addToTagCache=function(t,e){this.tagToEntities.has(t)||this.tagToEntities.set(t,[]),this.tagToEntities.get(t).push(e)},e.prototype.removeFromTagCache=function(t,e){var n=this.tagToEntities.get(t);if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},e}();t.EntityManager=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.systemWorkers=new Map,this.entityCache=new Map,this.dependencies=new Map,this.workerWarningDisplayed=!1,this.systems=[],this.entityManager=t,t.setSystemManager(this)}return t.prototype.registerSystem=function(t,e){var n=this;if(t.onRegister(),e&&this.dependencies.set(t,e),this.systems.push(t),this.sortSystemsByPriorityAndDependencies(),t.workerScript)if("undefined"==typeof Worker)this.workerWarningDisplayed||(console.warn("Web Workers 在当前环境中不受支持。系统将在主线程中运行"),this.workerWarningDisplayed=!0);else{var r=new Worker(t.workerScript);r.onmessage=function(t){var e,r,o=t.data.entities;try{for(var i=__values(o),a=i.next();!a.done;a=i.next()){var s=a.value,u=n.entityManager.getEntity(s.id);u&&u.deserialize(s)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}},this.systemWorkers.set(t,r)}},t.prototype.unregisterSystem=function(t){t.onUnregister();var e=this.systems.indexOf(t);e>-1&&this.systems.splice(e,1),this.systemWorkers.delete(t),this.entityCache.delete(t)},t.prototype.notifyComponentAdded=function(t){var e,n;try{for(var r=__values(this.systems),o=r.next();!o.done;o=r.next()){var i=o.value;i.handleComponentChange(t,!0),this.entityCache.delete(i)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},t.prototype.notifyComponentRemoved=function(t){var e,n;try{for(var r=__values(this.systems),o=r.next();!o.done;o=r.next()){var i=o.value;i.handleComponentChange(t,!1),this.entityCache.delete(i)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},t.prototype.invalidateEntityCacheForSystem=function(t){this.entityCache.delete(t)},t.prototype.update=function(){var t,e,n=this.entityManager.getEntities();try{for(var r=__values(this.systems),o=r.next();!o.done;o=r.next()){var i=o.value;if(i.isEnabled()&&!i.isPaused()){var a=this.entityCache.get(i);a||(a=i.filterEntities(n),this.entityCache.set(i,a));var s=this.systemWorkers.get(i);if(s){var u={entities:a.map(function(t){return t.serialize()})};s.postMessage(u)}else i.update(a)}}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},t.prototype.sortSystemsByPriorityAndDependencies=function(){var t=this;this.systems.sort(function(e,n){var r=e.priority-n.priority;return 0!==r?r:t.dependsOn(e,n)?1:t.dependsOn(n,e)?-1:0})},t.prototype.dependsOn=function(t,e){var n=this,r=this.dependencies.get(t);return!!r&&(-1!==r.indexOf(e)||r.some(function(t){return n.dependsOn(t,e)}))},t.prototype.dispose=function(){var t,e;try{for(var n=__values(this.systemWorkers.values()),r=n.next();!r.done;r=n.next()){r.value.terminate()}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}this.systemWorkers.clear(),this.entityCache.clear()},t}();t.SystemManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.deltaTime=0,this.timeScale=1,this.totalTime=0}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.update=function(t){this.deltaTime=t*this.timeScale,this.totalTime+=this.deltaTime},t}();t.TimeManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.networkAdapter=null}return t.prototype.setNetworkAdapter=function(t){this.networkAdapter=t},t.prototype.getNetworkAdpater=function(){return this.networkAdapter},t}();t.NetworkManager=e}(gs||(gs={})),function(t){var e=function(){function e(){this.snapshotQueue=[]}return e.prototype.sendState=function(t){},e.prototype.receiveState=function(t){this.snapshotQueue.push(t)},e.prototype.handleStateUpdate=function(e){if(!(this.snapshotQueue.length<2)){var n=this.snapshotQueue[0],r=this.snapshotQueue[1],o=t.TimeManager.getInstance().deltaTime,i=(o-n.timestamp)/(r.timestamp-n.timestamp);this.interpolateAndUpdateGameState(n,r,i),o>=r.timestamp&&this.snapshotQueue.shift()}},e.prototype.interpolateAndUpdateGameState=function(t,e,n){this.onInterpolation&&this.onInterpolation(t,e,n)},e}();t.SnapshotInterpolationStrategy=e}(gs||(gs={})),function(t){var e=function(){function t(){this.handleStateUpdate=function(){}}return t.prototype.sendState=function(t){var e=t;this.onCompressState&&(e=this.onCompressState(t)),this.onSendState&&this.onSendState(e)},t.prototype.receiveState=function(t){var e=t;this.onDecompressState&&(e=this.onDecompressState(t)),this.onReceiveState&&this.onReceiveState(e),this.handleStateUpdate(e)},t}();t.StateCompressionStrategy=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.strategy=t}return t.prototype.sendState=function(t){this.strategy.sendState(t)},t.prototype.receiveState=function(t){this.strategy.receiveState(t)},t.prototype.handleStateUpdate=function(t){this.strategy.handleStateUpdate(t)},t.prototype.setStrategy=function(t){this.strategy=t},t}();t.SyncStrategyManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.currentState=null,this.states=new Map}return t.prototype.addState=function(t,e){this.states.set(t,e)},t.prototype.changeState=function(t){if(this.states.has(t)){var e=this.states.get(t);this.currentState&&this.currentState.exit&&this.currentState.exit(),this.currentState=e,this.currentState.enter&&this.currentState.enter()}else console.warn('状态 "'+t+'" 不存在.')},t.prototype.update=function(){this.currentState&&this.currentState.update&&this.currentState.update()},t}();t.StateMachine=e}(gs||(gs={})),function(t){var e=function(e){function n(){var n=e.call(this)||this;return n.stateMachine=new t.StateMachine,n}return __extends(n,e),n.prototype.reset=function(){this.stateMachine=new t.StateMachine},n}(t.Component);t.StateMachineComponent=e}(gs||(gs={})),function(t){var e=function(e){function n(t){return e.call(this,t,1)||this}return __extends(n,e),n.prototype.entityFilter=function(e){return e.hasComponent(t.StateMachineComponent)},n.prototype.update=function(e){var n,r;try{for(var o=__values(e),i=o.next();!i.done;i=o.next()){i.value.getComponent(t.StateMachineComponent).stateMachine.update()}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}},n}(t.System);t.StateMachineSystem=e}(gs||(gs={})),function(t){var e=function(){function t(t){void 0===t&&(t=32),this.data=new Uint32Array(Math.ceil(t/32))}return t.prototype.set=function(t){var e=Math.floor(t/32),n=t%32;this.data[e]|=1<<n},t.prototype.clear=function(t){var e=Math.floor(t/32),n=t%32;this.data[e]&=~(1<<n)},t.prototype.get=function(t){var e=Math.floor(t/32),n=t%32;return 0!=(this.data[e]&1<<n)},t.prototype.resize=function(t){var e=new Uint32Array(Math.ceil(t/32));e.set(this.data),this.data=e},t}();t.Bits=e}(gs||(gs={})),function(t){var e=function(){function t(){this.nextId=0}return t.prototype.allocate=function(){var t=this.nextId;return this.nextId+=1,t},t}();t.EntityIdAllocator=e}(gs||(gs={})),function(t){var e=function(){function e(){this.allSet=[],this.exclusionSet=[],this.oneSet=[]}return e.empty=function(){return new e},e.prototype.getAllSet=function(){return this.allSet},e.prototype.getExclusionSet=function(){return this.exclusionSet},e.prototype.getOneSet=function(){return this.oneSet},e.prototype.isInterestedEntity=function(t){return this.isInterested(t.componentBits)},e.prototype.isInterested=function(t){return this.checkAllSet(t)&&this.checkExclusionSet(t)&&this.checkOneSet(t)},e.prototype.checkAllSet=function(e){var n,r;try{for(var o=__values(this.allSet),i=o.next();!i.done;i=o.next()){var a=i.value;if(!e.get(t.ComponentTypeManager.getIndexFor(a)))return!1}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return!0},e.prototype.checkExclusionSet=function(e){var n,r;try{for(var o=__values(this.exclusionSet),i=o.next();!i.done;i=o.next()){var a=i.value;if(e.get(t.ComponentTypeManager.getIndexFor(a)))return!1}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return!0},e.prototype.checkOneSet=function(e){var n,r;if(0===this.oneSet.length)return!0;try{for(var o=__values(this.oneSet),i=o.next();!i.done;i=o.next()){var a=i.value;if(e.get(t.ComponentTypeManager.getIndexFor(a)))return!0}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return!1},e.prototype.all=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.allSet).push.apply(t,__spread(e)),this},e.prototype.exclude=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.exclusionSet).push.apply(t,__spread(e)),this},e.prototype.one=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.oneSet).push.apply(t,__spread(e)),this},e}();t.Matcher=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.seed=t}return t.prototype.next=function(){return this.seed=(9301*this.seed+49297)%233280,this.seed/233280},t.prototype.nextInt=function(t,e){return t+Math.floor(this.next()*(e-t))},t.prototype.nextFloat=function(t,e){return t+this.next()*(e-t)},t.prototype.choose=function(t){return t[this.nextInt(0,t.length)]},t}();t.Random=e}(gs||(gs={})),function(t){var e=function(){function t(){this.sparse=[],this.dense=[],this.items=[],this.count=0}return t.prototype.add=function(t,e){t>=this.sparse.length&&(this.sparse.length=t+1),this.sparse[t]=this.count,this.dense[this.count]=t,this.items[this.count]=e,this.count++},t.prototype.remove=function(t){var e=this.sparse[t],n=this.count-1,r=this.dense[n],o=this.items[n];this.dense[e]=r,this.items[e]=o,this.sparse[r]=e,this.count--},t.prototype.has=function(t){return this.sparse[t]<this.count&&this.dense[this.sparse[t]]===t},t.prototype.get=function(t){return this.has(t)?this.items[this.sparse[t]]:null},t.prototype.getCount=function(){return this.count},t}();t.SparseSet=e}(gs||(gs={}));