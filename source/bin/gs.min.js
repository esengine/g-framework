window.gs={},window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};!function(t){var e=function(){function t(t,e){this.createFn=t,this.resetFn=e,this.pool=[]}return t.prototype.acquire=function(){if(this.pool.length>0){var t=this.pool.pop();return this.resetFn(t),t}return this.createFn()},t.prototype.release=function(t){this.pool.push(t)},t}();t.ObjectPool=e}(gs||(gs={})),function(t){var e=function(e){function n(){return e.call(this,function(){return new t.Event("",null)},function(t){t.type="",t.data=null})||this}return __extends(n,e),n}(t.ObjectPool);t.EventPool=e}(gs||(gs={})),function(t){var e=function(){function e(){this.listeners=new Map,this.eventPool=new t.EventPool}return e.prototype.on=function(t,e){this.listeners.has(t)||this.listeners.set(t,[]);var n=this.listeners.get(t);n&&n.push(e)},e.prototype.once=function(t,e){var n=this,r=function(o){n.off(t,r),e(o)};this.on(t,r)},e.prototype.off=function(t,e){var n=this.listeners.get(t);if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},e.prototype.emit=function(t,e){var n,r,o=this.eventPool.acquire();o.type=t,o.data=e;var i=this.listeners[t];if(i)try{for(var a=__values(i),s=a.next();!s.done;s=a.next()){(0,s.value)(o)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}this.eventPool.release(o)},e}();t.EventEmitter=e}(gs||(gs={})),function(t){t.GlobalEventEmitter=new t.EventEmitter}(gs||(gs={})),function(t){var e=function(){function t(){this._entityId=null}return t.prototype.setEntityId=function(t){this._entityId=t},Object.defineProperty(t.prototype,"entityId",{get:function(){if(null===this._entityId)throw new Error("Entity ID 还未被设置");return this._entityId},enumerable:!0,configurable:!0}),t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(Object.keys(this)),o=r.next();!o.done;o=r.next()){var i=o.value,a=this[i];"function"!=typeof a&&(n[i]=a)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){for(var e in t)void 0!==this[e]&&(this[e]=t[e])},t.getPropertyStorageTypes=function(){for(var e={},n=this.prototype,r=Object.keys(n),o=0;o<r.length;o++){var i=r[o];if(!t.registeredProperties.has(i)&&void 0!==n[i]){var a=n[i].storageType;a&&(e[i]=a)}}return e},t.registeredProperties=new Set,t.defaultDataSize=10,t}();t.Component=e}(gs||(gs={})),function(t){var e=function(){function e(e,n){this.id=e,this.componentManagers=n,this.tags=new Set,this.eventEmitter=new t.EventEmitter}return e.prototype.getId=function(){return this.id},e.prototype.addComponent=function(t){var e=this.componentManagers.get(t);if(!e)throw new Error("组件类型为 "+t.name+" 的组件管理器未找到.");return e.create(this.id)},e.prototype.getComponent=function(t){var e=this.componentManagers.get(t);return e?e.get(this.id):null},e.prototype.removeComponent=function(t){var e=this.componentManagers.get(t);e&&(this.getComponent(t)&&e.remove(this.id))},e.prototype.hasComponent=function(t){var e=this.componentManagers.get(t);return!!e&&e.has(this.id)},e.prototype.addTag=function(t){this.tags.add(t)},e.prototype.removeTag=function(t){this.tags.delete(t)},e.prototype.hasTag=function(t){return this.tags.has(t)},e.prototype.serialize=function(){var t,e,n={id:this.id,components:{}};try{for(var r=__values(this.componentManagers),o=r.next();!o.done;o=r.next()){var i=__read(o.value,2),a=i[0],s=i[1].get(this.id);s&&(n.components[a.name]=s.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},e.prototype.deserialize=function(t){var e,n;for(var r in t.components)try{for(var o=__values(this.componentManagers),i=o.next();!i.done;i=o.next()){var a=__read(i.value,2),s=a[0],u=a[1];if(s.name===r){var p=u.get(this.id);p&&p.deserialize(t.components[r]);break}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}},e.prototype.onCreate=function(){},e.prototype.onDestroy=function(){},e.prototype.on=function(t,e){this.eventEmitter.on(t,e)},e.prototype.once=function(t,e){this.eventEmitter.once(t,e)},e.prototype.off=function(t,e){this.eventEmitter.off(t,e)},e.prototype.emit=function(t,e){this.eventEmitter.emit(t,e)},e}();t.Entity=e}(gs||(gs={})),function(t){!function(t){t[t.Int8=0]="Int8",t[t.Int16=1]="Int16",t[t.Int32=2]="Int32",t[t.Uint8=3]="Uint8",t[t.Uint16=4]="Uint16",t[t.Uint32=5]="Uint32",t[t.Uint8Clamped=6]="Uint8Clamped",t[t.Float32=7]="Float32",t[t.Float64=8]="Float64"}(t.StorageType||(t.StorageType={}))}(gs||(gs={})),function(t){var e=function(){function t(t,e,n){this.paused=!1,this.enabled=!0,this.entityManager=t,this.priority=e,this.workerScript=n}return t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1},t.prototype.isPaused=function(){return this.paused},t.prototype.enable=function(){this.enabled=!0},t.prototype.disable=function(){this.enabled=!1},t.prototype.isEnabled=function(){return this.enabled},t.prototype.onRegister=function(){},t.prototype.onUnregister=function(){},t}();t.System=e}(gs||(gs={})),function(t){var e=function(){return function(t,e){this.type=t,this.data=e}}();t.Event=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.inputManager=t}return t.prototype.sendInputToManager=function(t){this.inputManager.sendInput(t)},t}();t.InputAdapter=e}(gs||(gs={})),function(t){var e=function(){function t(){this.buffer=[]}return t.prototype.addEvent=function(t){this.buffer.push(t)},t.prototype.hasEvents=function(){return this.buffer.length>0},t.prototype.getEvents=function(){return this.buffer},t.prototype.consumeEvent=function(){if(0===this.buffer.length)return null;var t=this.buffer[0];return this.buffer.shift(),t},t.prototype.clear=function(){this.buffer=[]},t}();t.InputBuffer=e}(gs||(gs={})),function(t){var e=function(){function e(e){this.inputHistory=[],this.entityManager=e,this.inputBuffer=new t.InputBuffer}return e.prototype.setAdapter=function(t){this.adapter=t},e.prototype.sendInput=function(t){this.handleInput(t)},e.prototype.handleInput=function(t){this.inputBuffer.addEvent(t),this.inputHistory.push({frameNumber:this.getCurrentFrameNumber(),input:t})},e.prototype.getCurrentFrameNumber=function(){return this.entityManager.getCurrentFrameNumber()},e.prototype.getInputBuffer=function(){return this.inputBuffer},e.prototype.getInputHistory=function(){return this.inputHistory},e}();t.InputManager=e}(gs||(gs={})),function(t){!function(t){t[t.KEY_DOWN=0]="KEY_DOWN",t[t.KEY_UP=1]="KEY_UP",t[t.MOUSE_DOWN=2]="MOUSE_DOWN",t[t.MOUSE_UP=3]="MOUSE_UP",t[t.MOUSE_MOVE=4]="MOUSE_MOVE"}(t.InputType||(t.InputType={}))}(gs||(gs={})),function(t){var e;!function(t){t[t.TypedArray=0]="TypedArray",t[t.Object=1]="Object"}(e=t.StorageMode||(t.StorageMode={}));var n=function(){function n(t,n,r){void 0===n&&(n=e.Object),void 0===r&&(r=10),this.data=[],this.entityToDataIndex=new Map,this.freeDataIndices=[],this.typedStorage=new Map,this.storageMode=n,this.componentType=t,this.dataSize=r}return n.prototype.create=function(t){var o=this.allocateDataIndex(),i=new this.componentType;if(i.setEntityId(t),n.registerComponent(this.componentType,this,t),this.storageMode===e.TypedArray){var a=this.componentType.getPropertyStorageTypes();for(var s in a){var u=a[s],p=this.getStorageKey(t,u);this.typedStorage.set(p,new(r(u))(i.constructor.prototype[u+"PropertyCount"]))}}else this.data[o]=i;return this.entityToDataIndex.set(t,o),i},n.prototype.get=function(t){var n=this.entityToDataIndex.get(t);if(void 0===n)return null;if(this.storageMode===e.TypedArray){var r=this.componentType.getPropertyStorageTypes(),o={};for(var i in r){var a=r[i],s=this.getStorageKey(t,a);o[i]=this.typedStorage.get(s)[n]}return o}return this.data[n]||{}},n.prototype.has=function(t){return this.entityToDataIndex.has(t)},n.prototype.remove=function(t){var n=this.entityToDataIndex.get(t);if(void 0!==n){if(this.entityToDataIndex.delete(t),this.storageMode===e.TypedArray){var r=this.componentType.getPropertyStorageTypes();for(var o in r){var i=r[o],a=this.getStorageKey(t,i);this.typedStorage.delete(a)}}else this.data[n]=null;this.freeDataIndices.push(n)}},n.prototype.allocateDataIndex=function(){return this.freeDataIndices.length>0?this.freeDataIndices.pop():this.data.length},n.prototype.getTypedArray=function(e,n){var r=this.getStorageKey(e,n);if(!this.typedStorage.has(r))switch(n){case t.StorageType.Int8:this.typedStorage.set(r,new Int8Array(this.dataSize));break;case t.StorageType.Int16:this.typedStorage.set(r,new Int16Array(this.dataSize));break;case t.StorageType.Int32:this.typedStorage.set(r,new Int32Array(this.dataSize));break;case t.StorageType.Float32:this.typedStorage.set(r,new Float32Array(this.dataSize));break;case t.StorageType.Float64:this.typedStorage.set(r,new Float64Array(this.dataSize));break;case t.StorageType.Uint8:this.typedStorage.set(r,new Uint8Array(this.dataSize));break;case t.StorageType.Uint16:this.typedStorage.set(r,new Uint16Array(this.dataSize));break;case t.StorageType.Uint32:this.typedStorage.set(r,new Uint32Array(this.dataSize));break;case t.StorageType.Uint8Clamped:this.typedStorage.set(r,new Uint8ClampedArray(this.dataSize))}return this.typedStorage.get(r)},n.prototype.getStorageKey=function(t,e){return t+"_"+e},n.registerComponent=function(n,o,i){for(var a=new n,s=Object.keys(a),u=function(a){var u=s[a];t.Component.registeredProperties.add(u);var p=n.prototype[u]&&n.prototype[u].storageType;if(p&&o.storageMode===e.TypedArray){var c=o.allocateDataIndex(),y=o.getStorageKey(i,p);o.typedStorage.has(y)||o.typedStorage.set(y,new(r(p))(o.dataSize)),Object.defineProperty(n.prototype,u,{get:function(){return o.typedStorage.get(y)[c]},set:function(t){o.typedStorage.get(y)[c]=t},enumerable:!0,configurable:!0})}else{var f=o.allocateDataIndex();Object.defineProperty(n.prototype,u,{get:function(){return o.get(f)[u]},set:function(t){o.get(f)[u]=t},enumerable:!0,configurable:!0})}},p=0;p<s.length;p++)u(p)},n}();function r(e){switch(e){case t.StorageType.Float32:return Float32Array;case t.StorageType.Int32:return Int32Array;case t.StorageType.Uint32:return Uint32Array;case t.StorageType.Uint16:return Uint16Array;case t.StorageType.Uint8:return Uint8Array;case t.StorageType.Uint8Clamped:return Uint8ClampedArray;case t.StorageType.Int16:return Int16Array;case t.StorageType.Int8:return Int8Array;case t.StorageType.Float64:return Float64Array;default:throw new Error("不支持 storageType: "+e)}}t.ComponentManager=n,t.typedProperty=function(t){return function(e,n){e[n]=e[n]||{},e[n].storageType=t}},t.useTypedArrayStorage=function(t){t.useTypedArrayStorage=!0},t.getArrayConstructor=r}(gs||(gs={})),function(t){var e=function(){function e(e){var n,r;this.entities=new Map,this.entityIdAllocator=new t.EntityIdAllocator,this.inputManager=new t.InputManager(this),this.networkManager=new t.NetworkManager,this.currentFrameNumber=0,this.componentManagers=new Map;try{for(var o=__values(e),i=o.next();!i.done;i=o.next()){var a=i.value,s=a.useTypedArrayStorage?t.StorageMode.TypedArray:t.StorageMode.Object,u=a.defaultDataSize||10,p=new t.ComponentManager(a,s,u);this.componentManagers.set(a,p)}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}}return e.prototype.updateFrameNumber=function(){this.currentFrameNumber++},e.prototype.getCurrentFrameNumber=function(){return this.currentFrameNumber},e.prototype.getInputManager=function(){return this.inputManager},e.prototype.getNetworkManager=function(){return this.networkManager},e.prototype.createEntity=function(){var e=this.entityIdAllocator.allocate(),n=new t.Entity(e,this.componentManagers);return n.onCreate(),this.entities.set(e,n),n},e.prototype.deleteEntity=function(t){var e=this.getEntity(t);e&&(e.onDestroy(),this.entities.delete(t))},e.prototype.getEntity=function(t){return this.entities.has(t)?this.entities.get(t):null},e.prototype.getEntitiesWithComponent=function(t){var e,n,r=[];try{for(var o=__values(this.getEntities()),i=o.next();!i.done;i=o.next()){var a=i.value;a.hasComponent(t)&&r.push(a)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}return r},e.prototype.getEntities=function(){return Array.from(this.entities.values())},e.prototype.getEntitiesWithTag=function(t){var e,n,r=[];try{for(var o=__values(this.getEntities()),i=o.next();!i.done;i=o.next()){var a=i.value;a.hasTag(t)&&r.push(a)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}return r},e.prototype.createStateSnapshot=function(){var t,e,n={entities:[]};try{for(var r=__values(this.getEntities()),o=r.next();!o.done;o=r.next()){var i=o.value;n.entities.push(i.serialize())}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},e.prototype.updateStateFromSnapshot=function(e){var n,r,o=new Map;try{for(var i=__values(e.entities),a=i.next();!a.done;a=i.next()){var s=a.value,u=s.id,p=this.getEntity(u);p||(p=new t.Entity(u,this.componentManagers)).onCreate(),p.deserialize(s),o.set(u,p)}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}this.entities=o},e.prototype.applyInterpolation=function(e){var n,r,o,i;try{for(var a=__values(this.getEntities()),s=a.next();!s.done;s=a.next()){var u=s.value;try{for(var p=__values(this.componentManagers),c=p.next();!c.done;c=p.next()){var y=__read(c.value,2),f=y[0],h=(y[1],u.getComponent(f));h instanceof t.Component&&"savePreviousState"in h&&"applyInterpolation"in h&&h.applyInterpolation(e)}}catch(t){o={error:t}}finally{try{c&&!c.done&&(i=p.return)&&i.call(p)}finally{if(o)throw o.error}}}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}},e}();t.EntityManager=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.systemWorkers=new Map,this.systems=[],this.entityManager=t}return t.prototype.registerSystem=function(t){if(t.onRegister(),this.systems.push(t),this.systems.sort(function(t,e){return t.priority-e.priority}),t.workerScript)if("undefined"==typeof Worker)console.warn("Web Workers 在当前环境中不受支持。系统将在主线程中运行");else{var e=new Worker(t.workerScript);this.systemWorkers.set(t,e)}},t.prototype.unregisterSystem=function(t){t.onUnregister();var e=this.systems.indexOf(t);e>-1&&this.systems.splice(e,1)},t.prototype.update=function(){var t,e,n=this,r=this.entityManager.getEntities(),o=function(t){if(!t.isEnabled()||t.isPaused())return"continue";var e=r.filter(function(e){return t.entityFilter(e)}),o=i.systemWorkers.get(t);if(o){var a={entities:e.map(function(t){return t.serialize()})};o.postMessage(a),o.onmessage=function(t){var e,r,o=t.data.entities;try{for(var i=__values(o),a=i.next();!a.done;a=i.next()){var s=a.value,u=n.entityManager.getEntity(s.id);u&&u.deserialize(s)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}}else t.update(e)},i=this;try{for(var a=__values(this.systems),s=a.next();!s.done;s=a.next()){o(s.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}},t}();t.SystemManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.deltaTime=0,this.timeScale=1,this.totalTime=0}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.update=function(t){this.deltaTime=t*this.timeScale,this.totalTime+=this.deltaTime},t}();t.TimeManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.networkAdapter=null}return t.prototype.setNetworkAdapter=function(t){this.networkAdapter=t},t.prototype.getNetworkAdpater=function(){return this.networkAdapter},t}();t.NetworkManager=e}(gs||(gs={})),function(t){var e=function(){function t(){this.currentState=null,this.states=new Map}return t.prototype.addState=function(t,e){this.states.set(t,e)},t.prototype.changeState=function(t){if(this.states.has(t)){var e=this.states.get(t);this.currentState&&this.currentState.exit&&this.currentState.exit(),this.currentState=e,this.currentState.enter&&this.currentState.enter()}else console.warn('状态 "'+t+'" 不存在.')},t.prototype.update=function(){this.currentState&&this.currentState.update&&this.currentState.update()},t}();t.StateMachine=e}(gs||(gs={})),function(t){var e=function(e){function n(){var n=e.call(this)||this;return n.stateMachine=new t.StateMachine,n}return __extends(n,e),n}(t.Component);t.StateMachineComponent=e}(gs||(gs={})),function(t){var e=function(e){function n(t){return e.call(this,t,1)||this}return __extends(n,e),n.prototype.entityFilter=function(e){return e.hasComponent(t.StateMachineComponent)},n.prototype.update=function(e){var n,r;try{for(var o=__values(e),i=o.next();!i.done;i=o.next()){i.value.getComponent(t.StateMachineComponent).stateMachine.update()}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}},n}(t.System);t.StateMachineSystem=e}(gs||(gs={})),function(t){var e=function(){function t(){this.nextId=0}return t.prototype.allocate=function(){var t=this.nextId;return this.nextId+=1,t},t}();t.EntityIdAllocator=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.seed=t}return t.prototype.next=function(){return this.seed=(9301*this.seed+49297)%233280,this.seed/233280},t.prototype.nextInt=function(t,e){return t+Math.floor(this.next()*(e-t))},t.prototype.nextFloat=function(t,e){return t+this.next()*(e-t)},t.prototype.choose=function(t){return t[this.nextInt(0,t.length)]},t}();t.Random=e}(gs||(gs={}));