window.gs={};var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s};window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),function(t){var e=function(){function t(){}return t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(Object.keys(this)),o=r.next();!o.done;o=r.next()){var i=o.value,s=this[i];"function"!=typeof s&&(n[i]=s)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){for(var e in t)void 0!==this[e]&&(this[e]=t[e])},t}();t.Component=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.id=t,this.components=new Map}return t.prototype.addComponent=function(t){return this.components.set(t.constructor.name,t),this},t.prototype.removeComponent=function(t){return this.components.delete(t.name),this},t.prototype.getComponent=function(t){var e=t.name;return this.components.has(e)?this.components.get(e):null},t.prototype.hasComponent=function(t){return this.components.has(t.name)},t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(this.components),o=r.next();!o.done;o=r.next()){var i=__read(o.value,2),s=i[0],a=i[1];n[s]=a.serialize()}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return{id:this.id,components:n}},t.prototype.deserialize=function(t){for(var e in this.id=t.id,t.components)this.components.has(e)&&this.components.get(e).deserialize(t.components[e])},t}();t.Entity=e}(gs||(gs={})),function(t){var e=function(){function t(){this.nextId=0}return t.prototype.generateId=function(){var t=this.nextId;return this.nextId+=1,t},t}();t.EntityIdAllocator=e}(gs||(gs={})),function(t){var e=function(){function e(){this.entities=new Map,this.idAllocator=new t.EntityIdAllocator}return e.prototype.createEntity=function(){var e=new t.Entity(this.idAllocator.generateId());return this.entities.set(e.id,e),e},e.prototype.deleteEntity=function(t){this.entities.delete(t)},e.prototype.getEntity=function(t){return this.entities.has(t)?this.entities.get(t):null},e.prototype.getEntitiesWithComponent=function(t){var e,n,r=[];try{for(var o=__values(this.getEntities()),i=o.next();!i.done;i=o.next()){var s=i.value;s.hasComponent(t)&&r.push(s)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}return r},e.prototype.getEntities=function(){return Array.from(this.entities.values())},e}();t.EntityManager=e}(gs||(gs={})),function(t){var e=function(){return function(t,e){this.type=t,this.data=e}}();t.Event=e;var n=function(){function e(){this.listeners=new Map,this.eventPool=new t.EventPool}return e.prototype.on=function(t,e){this.listeners.has(t)||this.listeners.set(t,[]);var n=this.listeners.get(t);n&&n.push(e)},e.prototype.once=function(t,e){var n=this,r=function(o){n.off(t,r),e(o)};this.on(t,r)},e.prototype.off=function(t,e){var n=this.listeners.get(t);if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},e.prototype.emit=function(t,e){var n,r,o=this.eventPool.acquire();o.type=t,o.data=e;var i=this.listeners[t];if(i)try{for(var s=__values(i),a=s.next();!a.done;a=s.next()){(0,a.value)(o)}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}this.eventPool.release(o)},e}();t.EventEmitter=n}(gs||(gs={})),function(t){var e=function(){function t(t,e){this.createFn=t,this.resetFn=e,this.pool=[]}return t.prototype.acquire=function(){if(this.pool.length>0){var t=this.pool.pop();return this.resetFn(t),t}return this.createFn()},t.prototype.release=function(t){this.pool.push(t)},t}();t.ObjectPool=e}(gs||(gs={})),function(t){var e=function(e){function n(){return e.call(this,function(){return new t.Event("",null)},function(t){t.type="",t.data=null})||this}return __extends(n,e),n}(t.ObjectPool);t.EventPool=e}(gs||(gs={})),function(t){t.GlobalEventEmitter=new t.EventEmitter}(gs||(gs={})),function(t){var e=function(){return function(t,e,n){this.entityManager=t,this.priority=e,this.workerScript=n}}();t.System=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.systemWorkers=new Map,this.systems=[],this.entityManager=t}return t.prototype.registerSystem=function(t){if(this.systems.push(t),this.systems.sort(function(t,e){return t.priority-e.priority}),t.workerScript)if("undefined"==typeof Worker)console.warn("Web Workers 在当前环境中不受支持。系统将在主线程中运行");else{var e=new Worker(t.workerScript);this.systemWorkers.set(t,e)}},t.prototype.update=function(t){var e,n,r=this,o=this.entityManager.getEntities(),i=function(e){var n=o.filter(function(t){return e.entityFilter(t)}),i=s.systemWorkers.get(e);if(i){var a={deltaTime:t,entities:n.map(function(t){return t.serialize()})};i.postMessage(a),i.onmessage=function(t){var e,n,o=t.data.entities;try{for(var i=__values(o),s=i.next();!s.done;s=i.next()){var a=s.value,u=r.entityManager.getEntity(a.id);u&&u.deserialize(a)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}}}else e.update(t,n)},s=this;try{for(var a=__values(this.systems),u=a.next();!u.done;u=a.next()){i(u.value)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}},t}();t.SystemManager=e}(gs||(gs={}));