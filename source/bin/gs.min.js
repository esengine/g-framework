window.gs={};var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s};!function(t){var e=function(){function t(){}return t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(Object.keys(this)),i=r.next();!i.done;i=r.next()){var o=i.value,s=this[o];"function"!=typeof s&&(n[o]=s)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},t.prototype.deserialize=function(t){for(var e in t)void 0!==this[e]&&(this[e]=t[e])},t}();t.Component=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.id=t,this.components=new Map}return t.prototype.addComponent=function(t){return this.components.set(t.constructor.name,t),this},t.prototype.removeComponent=function(t){return this.components.delete(t.name),this},t.prototype.getComponent=function(t){var e=t.name;return this.components.has(e)?this.components.get(e):null},t.prototype.hasComponent=function(t){return this.components.has(t.name)},t.prototype.serialize=function(){var t,e,n={};try{for(var r=__values(this.components),i=r.next();!i.done;i=r.next()){var o=__read(i.value,2),s=o[0],a=o[1];n[s]=a.serialize()}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return{id:this.id,components:n}},t.prototype.deserialize=function(t){for(var e in this.id=t.id,t.components)this.components.has(e)&&this.components.get(e).deserialize(t.components[e])},t}();t.Entity=e}(gs||(gs={})),function(t){var e=function(){function t(){this.nextId=0}return t.prototype.generateId=function(){var t=this.nextId;return this.nextId+=1,t},t}();t.EntityIdAllocator=e}(gs||(gs={})),function(t){var e=function(){function e(){this.entities=new Map,this.idAllocator=new t.EntityIdAllocator}return e.prototype.createEntity=function(){var e=new t.Entity(this.idAllocator.generateId());return this.entities.set(e.id,e),e},e.prototype.deleteEntity=function(t){this.entities.delete(t)},e.prototype.getEntity=function(t){return this.entities.has(t)?this.entities.get(t):null},e.prototype.getEntities=function(){return Array.from(this.entities.values())},e}();t.EntityManager=e}(gs||(gs={})),function(t){var e=function(){return function(t,e,n){this.entityManager=t,this.priority=e,this.workerScript=n}}();t.System=e}(gs||(gs={})),function(t){var e=function(){function t(t){this.systemWorkers=new Map,this.systems=[],this.entityManager=t}return t.prototype.registerSystem=function(t){if(this.systems.push(t),this.systems.sort(function(t,e){return t.priority-e.priority}),t.workerScript)if("undefined"==typeof Worker)console.warn("Web Workers 在当前环境中不受支持。系统将在主线程中运行");else{var e=new Worker(t.workerScript);this.systemWorkers.set(t,e)}},t.prototype.update=function(t){var e,n,r=this,i=this.entityManager.getEntities(),o=function(e){var n=i.filter(function(t){return e.entityFilter(t)}),o=s.systemWorkers.get(e);if(o){var a={deltaTime:t,entities:n.map(function(t){return t.serialize()})};o.postMessage(a),o.onmessage=function(t){var e,n,i=t.data.entities;try{for(var o=__values(i),s=o.next();!s.done;s=o.next()){var a=s.value,u=r.entityManager.getEntity(a.id);u&&u.deserialize(a)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(e)throw e.error}}}}else e.update(t,n)},s=this;try{for(var a=__values(this.systems),u=a.next();!u.done;u=a.next()){o(u.value)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}},t}();t.SystemManager=e}(gs||(gs={}));